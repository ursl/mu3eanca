<!-- views/index.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mu3e Run Database</title>
    <style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100vh;
        width: 100%;
        overflow: hidden;
    }
    
    body {
        display: flex;
        flex-direction: column;
    }

    h1 {
        color: green;
        margin-bottom: 20px;
    }

    .header-section {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 0;
        margin-bottom: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        max-height: 50vh;
        overflow-y: auto;
    }

    .content-section {
        flex: 1;
        padding: 0 20px;
        padding-top: 20px;
        padding-bottom: 20px;
        margin-top: 0;
        margin-bottom: 0;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100vh;
    }

    .filter-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 15px;
        background-color: white;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 4px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
    }

    .filter-group.significant {
        background-color: #e8f5e9;
        border-color: #c8e6c9;
    }

    .filter-group label {
        white-space: nowrap;
        font-size: 13px;
        color: #495057;
        font-weight: 500;
    }

    .filter-group input[type="numeric"],
    .filter-group input[type="text"],
    .filter-group select {
        min-width: 120px;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 13px;
    }

    .filter-group input[type="numeric"] {
        width: 80px;
    }

    .filter-group.run-range input[type="numeric"] {
        width: 70px;
    }

    .button {
        background-color: #04AA6D;
        border: none;
        color: white;
        padding: 6px 14px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 13px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-weight: 500;
    }

    .button:hover {
        background-color: #038857;
    }

    input[type="numeric"], input[type="text"] {
        padding: 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    .status-text {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
    }

    .status-significant {
        color: #2e7d32;
        font-weight: bold;
    }

    .status-not-significant {
        color: #c62828;
        font-weight: bold;
    }

    .status-unset {
        color: #757575;
        font-style: italic;
    }

    .table-container {
        flex: 1;
        display: block;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        min-height: 200px;
        max-height: calc(100vh - 400px);
        overflow: auto;
        position: relative;
    }
    .main-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: fixed;
        background: white;
    }
    .main-table th, .main-table td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: left;
        font-size: 14px;
    }
    .main-table th {
        background: #04AA6D !important;
        color: white !important;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
    }
    .main-table thead {
        position: sticky;
        top: 0;
        z-index: 100;
        display: table-header-group;
    }
    /* Fix border overlap for sticky header */
    .main-table thead th {
        border-top: 1px solid #ddd;
        border-bottom: 2px solid #ddd;
    }
    /* Ensure header is always visible */
    .main-table thead tr {
        display: table-row;
    }
    .main-table tbody tr:first-child td {
        border-top: 1px solid #ddd;
    }
    .main-table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    .main-table tbody tr:hover {
        background-color: #ddd;
    }
    /* Column widths - total should be 100% */
    .main-table th:nth-child(1), .main-table td:nth-child(1) { width: 3%; }
    .main-table th:nth-child(2), .main-table td:nth-child(2) { width: 5%; }
    .main-table th:nth-child(3), .main-table td:nth-child(3) { width: 13%; }
    .main-table th:nth-child(4), .main-table td:nth-child(4) { width: 13%; }
    .main-table th:nth-child(5), .main-table td:nth-child(5) { width: 2%; }
    .main-table th:nth-child(6), .main-table td:nth-child(6) { width: 5%; }
    .main-table th:nth-child(7), .main-table td:nth-child(7) { width: 5%; }
    .main-table th:nth-child(8), .main-table td:nth-child(8) { width: 12%; }
    .main-table th:nth-child(9), .main-table td:nth-child(9) { width: 32%; }
    .main-table th:nth-child(10), .main-table td:nth-child(10) { width: 10%; }

    /* Collapsible CSV box styles */
    .csv-box {
        margin-top: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        flex-shrink: 0;
        max-height: 40vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .csv-header {
        background: #04AA6D;
        color: white;
        padding: 10px 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }

    .csv-header:hover {
        background: #038857;
    }

    .csv-content {
        padding: 5px 10px;
        display: none;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
        background: #f8f9fa;
        border-top: 1px solid #ddd;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
    }

    .csv-content.expanded {
        display: block;
    }

    .toggle-icon {
        transition: transform 0.3s ease;
    }

    .toggle-icon.expanded {
        transform: rotate(180deg);
    }

    /* Collapsible Data Quality filter section */
    .dq-filter-box {
        margin-top: 8px;
        border: 1px solid #ffc107;
        border-radius: 4px;
        background: white;
    }

    .dq-filter-header {
        background: #fff3cd;
        color: #856404;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        border-radius: 4px 4px 0 0;
        font-weight: bold;
    }

    .dq-filter-header:hover {
        background: #ffe69c;
    }

    .dq-filter-content {
        padding: 6px;
        display: none;
        border-top: 1px solid #ffc107;
    }

    .dq-filter-content.expanded {
        display: block;
    }

    /* Compact styles for Data Quality filter groups */
    .dq-filter-content .filter-row {
        gap: 6px;
        flex-wrap: nowrap;
    }

    .dq-filter-content .filter-group {
        padding: 4px 6px;
        gap: 4px;
        flex-shrink: 1;
        min-width: 0;
    }

    .dq-filter-content .filter-group label {
        font-size: 11px;
        font-weight: 400;
    }

    .dq-filter-content .filter-group select {
        min-width: 60px;
        padding: 2px 4px;
        font-size: 11px;
        width: auto;
        transition: background-color 0.2s ease;
    }

    .dq-filter-content .filter-group select.active {
        background-color: #fff3cd;
        border-color: #ffc107;
        font-weight: 500;
    }

    .dq-toggle-icon {
        transition: transform 0.3s ease;
    }

    .dq-toggle-icon.expanded {
        transform: rotate(180deg);
    }

    /* Bulk action styles */
    .bulk-actions {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        display: none;
        flex-shrink: 0;
    }

    .bulk-actions.visible {
        display: block;
    }

    .bulk-actions .action-group {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 10px;
    }

    .bulk-actions .action-group:last-child {
        margin-bottom: 0;
    }

    .bulk-actions select,
    .bulk-actions input[type="text"] {
        padding: 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    .bulk-actions .button {
        margin-left: 10px;
    }

    .bulk-actions .status {
        margin-left: 15px;
        font-size: 14px;
        color: #666;
    }

    .bulk-actions .status.success {
        color: #2e7d32;
    }

    .bulk-actions .status.error {
        color: #c62828;
    }
</style>

<script>
let isFiltered = true;
let onlySignificant = "yes";
let isOnlySignificant = true;
let NMAXRUNS = 1000;

// Function to adjust layout based on header height
function adjustLayout() {
    const headerSection = document.querySelector('.header-section');
    const contentSection = document.querySelector('.content-section');
    
    if (headerSection && contentSection) {
        const headerHeight = headerSection.offsetHeight;
        const viewportHeight = window.innerHeight;
        // Set content section height to fill remaining viewport space
        contentSection.style.height = (viewportHeight - headerHeight) + 'px';
        contentSection.style.marginTop = headerHeight + 'px';
        
        // Ensure table container has minimum space even when CSV is open
        const tableContainer = document.querySelector('.table-container');
        const csvBox = document.querySelector('.csv-box');
        if (tableContainer && csvBox) {
            const csvExpanded = csvBox.querySelector('.csv-content.expanded');
            if (csvExpanded) {
                // When CSV is open, ensure table gets at least 50% of available space
                const availableHeight = viewportHeight - headerHeight - 100; // 100px for padding/margins
                tableContainer.style.minHeight = Math.max(200, availableHeight * 0.5) + 'px';
            } else {
                tableContainer.style.minHeight = '200px';
            }
        }
    }
    
    // Ensure table header is visible - force a repaint
    const tableHeader = document.querySelector('.main-table thead');
    if (tableHeader) {
        tableHeader.style.display = 'table-header-group';
    }
}

// Initialize checkbox state on page load
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Remove keepCsvOpen from URL if present (it's client-side only)
    if (urlParams.has('keepCsvOpen')) {
        urlParams.delete('keepCsvOpen');
        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newUrl);
    }
    
    const significantParam = urlParams.get('onlySignificant');
    const checkbox = document.getElementById("filterSignificant");
    if (checkbox) {
        checkbox.checked = significantParam === null ? true : significantParam === "yes";
        onlySignificant = significantParam === null ? "yes" : significantParam;
        isOnlySignificant = checkbox.checked;
    }
    
    // Adjust layout after page loads
    setTimeout(adjustLayout, 100); // Small delay to ensure DOM is fully rendered
    adjustLayout(); // Also call immediately
    
    // Adjust layout on window resize
    window.addEventListener('resize', adjustLayout);
    
    // Watch for header height changes (e.g., when filters expand)
    const headerSection = document.querySelector('.header-section');
    if (headerSection) {
        const resizeObserver = new ResizeObserver(() => {
            adjustLayout();
        });
        resizeObserver.observe(headerSection);
    }

    // Set initial values from URL parameters
    document.getElementById("filterRunLimit").value = urlParams.get('nRun') || '';
    document.getElementById("filterRunMin").value = urlParams.get('minRun') || '';
    document.getElementById("filterRunMax").value = urlParams.get('maxRun') || '';
    document.getElementById("filterComment").value = urlParams.get('comment') || '';
    document.getElementById("filterRunClass").value = urlParams.get('runClass') || '';
    
    // Set Data Quality filter values from URL parameters
    const dqFilterIds = ['filterDqMu3e', 'filterDqBeam', 'filterDqVtx', 'filterDqPix', 'filterDqFib', 'filterDqTil', 'filterDqLks'];
    const dqFilterParams = ['dqMu3e', 'dqBeam', 'dqVtx', 'dqPix', 'dqFib', 'dqTil', 'dqLks'];
    
    dqFilterIds.forEach((id, index) => {
        const element = document.getElementById(id);
        if (element) {
            element.value = urlParams.get(dqFilterParams[index]) || '';
            updateDqFilterColor(element);
            // Add event listener to update color when value changes
            element.addEventListener('change', function() {
                updateDqFilterColor(this);
            });
        }
    });

    // Add event listener for Enter key on the filter form
    document.getElementById("filterForm").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            applyFilters();
        }
    });

    // Initialize CSV box toggle
    const csvHeader = document.querySelector('.csv-header');
    const csvContent = document.querySelector('.csv-content');
    const toggleIcon = document.querySelector('.toggle-icon');
    const csvSectionOpenFlag = document.getElementById('csvSectionOpen');
    
    if (csvHeader && csvContent) {
        csvHeader.addEventListener('click', () => {
            const isExpanded = csvContent.classList.contains('expanded');
            csvContent.classList.toggle('expanded');
            toggleIcon.classList.toggle('expanded');
            // Update status flag and localStorage (client-side only, not URL)
            const newState = !isExpanded;
            csvSectionOpenFlag.value = newState ? 'true' : 'false';
            if (newState) {
                localStorage.setItem('csvSectionOpen', 'true');
            } else {
                localStorage.removeItem('csvSectionOpen');
            }
            // Adjust layout when CSV section is toggled
            setTimeout(adjustLayout, 100);
        });
        
        // Check if CSV section should be open from localStorage only (not URL)
        const keepCsvOpen = localStorage.getItem('csvSectionOpen') === 'true';
        if (keepCsvOpen) {
            csvContent.classList.add('expanded');
            toggleIcon.classList.add('expanded');
            csvSectionOpenFlag.value = 'true';
            // Auto-update CSV display when section is open on page load
            setTimeout(() => {
                if (csvSectionOpenFlag.value === 'true') {
                    updateCsvDisplay();
                }
            }, 100);
        }
    }
    
    // Check if any Data Quality filters are active and expand if so
    const hasActiveDqFilters = urlParams.get('dqMu3e') || urlParams.get('dqBeam') || 
                                 urlParams.get('dqVtx') || urlParams.get('dqPix') || 
                                 urlParams.get('dqFib') || urlParams.get('dqTil') || 
                                 urlParams.get('dqLks');
    if (hasActiveDqFilters) {
        const dqContent = document.getElementById('dqFilterContent');
        const dqToggleIcon = document.querySelector('.dq-toggle-icon');
        if (dqContent && dqToggleIcon) {
            dqContent.classList.add('expanded');
            dqToggleIcon.classList.add('expanded');
        }
    }
}

// Update Data Quality filter select box color based on value
function updateDqFilterColor(selectElement) {
    if (selectElement.value && selectElement.value !== '') {
        selectElement.classList.add('active');
    } else {
        selectElement.classList.remove('active');
    }
}

// Toggle Data Quality filters visibility
function toggleDqFilters() {
    const dqContent = document.getElementById('dqFilterContent');
    const dqToggleIcon = document.querySelector('.dq-toggle-icon');
    
    if (dqContent && dqToggleIcon) {
        dqContent.classList.toggle('expanded');
        dqToggleIcon.classList.toggle('expanded');
        
        // Adjust layout after toggle to account for header height change
        setTimeout(adjustLayout, 100);
    }
}

function applyFilters() {
    isFiltered = true;
    const urlParams = new URLSearchParams();
    
    // Always include onlySignificant parameter
    urlParams.set('onlySignificant', onlySignificant);

    // Get all filter values
    const nRun = document.getElementById("filterRunLimit").value;
    const minRun = document.getElementById("filterRunMin").value;
    const maxRun = document.getElementById("filterRunMax").value;
    const comment = document.getElementById("filterComment").value;
    const runClass = document.getElementById("filterRunClass").value;

    // Only add parameters that have values
    if (nRun) urlParams.set('nRun', nRun);
    if (minRun) urlParams.set('minRun', minRun);
    if (maxRun) urlParams.set('maxRun', maxRun);
    if (comment) urlParams.set('comment', comment);
    if (runClass) urlParams.set('runClass', runClass);

    // Get Data Quality filter values
    const dqMu3e = document.getElementById("filterDqMu3e").value;
    const dqBeam = document.getElementById("filterDqBeam").value;
    const dqVtx = document.getElementById("filterDqVtx").value;
    const dqPix = document.getElementById("filterDqPix").value;
    const dqFib = document.getElementById("filterDqFib").value;
    const dqTil = document.getElementById("filterDqTil").value;
    const dqLks = document.getElementById("filterDqLks").value;

    // Only add Data Quality parameters that have values
    if (dqMu3e) urlParams.set('dqMu3e', dqMu3e);
    if (dqBeam) urlParams.set('dqBeam', dqBeam);
    if (dqVtx) urlParams.set('dqVtx', dqVtx);
    if (dqPix) urlParams.set('dqPix', dqPix);
    if (dqFib) urlParams.set('dqFib', dqFib);
    if (dqTil) urlParams.set('dqTil', dqTil);
    if (dqLks) urlParams.set('dqLks', dqLks);

    // Preserve pagination parameters (reset to page 1, but keep pageSize)
    urlParams.set('page', '1');
    const currentPageSize = new URL(window.location.href).searchParams.get('pageSize');
    if (currentPageSize) {
        urlParams.set('pageSize', currentPageSize);
    }
    
    // Navigate to the new URL with all active filters
    window.location.href = '/rdb/?' + urlParams.toString();
}

function significantFilter() {
    const checkbox = document.getElementById("filterSignificant");
    onlySignificant = checkbox.checked ? "yes" : "no";
    isOnlySignificant = checkbox.checked;
    applyFilters();
}

let selectedRuns = new Set();

function toggleAllRuns(checkbox) {
    const runCheckboxes = document.querySelectorAll('.run-select');
    runCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        const runNumber = cb.getAttribute('data-run');
        if (checkbox.checked) {
            selectedRuns.add(runNumber);
        } else {
            selectedRuns.delete(runNumber);
        }
    });
    updateBulkActionsVisibility();
}

function toggleRun(checkbox) {
    const runNumber = checkbox.getAttribute('data-run');
    if (checkbox.checked) {
        selectedRuns.add(runNumber);
    } else {
        selectedRuns.delete(runNumber);
    }
    updateBulkActionsVisibility();
}

function updateBulkActionsVisibility() {
    const bulkActions = document.querySelector('.bulk-actions');
    if (selectedRuns.size > 0) {
        bulkActions.classList.add('visible');
    } else {
        bulkActions.classList.remove('visible');
    }
}

async function performBulkAction(action) {
    const runs = Array.from(selectedRuns);
    if (runs.length === 0) return;

    const statusElement = document.querySelector('.bulk-actions .status');
    statusElement.textContent = 'Processing...';
    statusElement.className = 'status';

    try {
        let endpoint = '';
        let payload = { runs };

        switch (action) {
            case 'significant':
                const significant = document.getElementById('bulkSignificant').value;
                endpoint = '/rdb/bulk/significant';
                payload.value = significant === 'true';
                break;
            case 'comments':
                const comments = document.getElementById('bulkComments').value;
                endpoint = '/rdb/bulk/comments';
                payload.comments = comments;
                break;
            case 'class':
                const runClass = document.getElementById('bulkClass').value;
                endpoint = '/rdb/bulk/class';
                payload.class = runClass;
                break;
        }

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('Server error');

        const result = await response.json();
        statusElement.textContent = `Successfully updated ${result.updated} runs`;
        statusElement.className = 'status success';

        // Refresh the page after 1.5 seconds to show updated data
        setTimeout(() => window.location.reload(), 1500);
    } catch (error) {
        statusElement.textContent = `Error: ${error.message}`;
        statusElement.className = 'status error';
    }
}

function goToPage(page) {
    const url = new URL(window.location.href);
    url.searchParams.set('page', page);
    
    // Remove keepCsvOpen from URL if present (it's client-side only)
    url.searchParams.delete('keepCsvOpen');
    
    // Preserve all existing query parameters (except keepCsvOpen)
    window.location.href = url.toString();
}

function changePageSize(pageSize) {
    const url = new URL(window.location.href);
    url.searchParams.set('pageSize', pageSize);
    url.searchParams.set('page', '1'); // Reset to first page when changing page size
    // Preserve all existing query parameters
    window.location.href = url.toString();
}

let allRunNumbersCache = null;

// Store current page run numbers on page load
let currentPageRunNumbers = null;

async function updateCsvDisplay() {
    const scope = document.querySelector('input[name="csvScope"]:checked').value;
    const csvRunNumbers = document.getElementById('csvRunNumbers');
    const csvLoading = document.getElementById('csvLoading');
    
    if (scope === 'current') {
        // Show current page run numbers
        csvLoading.style.display = 'none';
        csvRunNumbers.style.display = 'block';
        
        // Use cached current page numbers or extract from DOM
        if (currentPageRunNumbers) {
            csvRunNumbers.value = currentPageRunNumbers;
        } else {
            // Fallback: extract from DOM
            const currentRuns = Array.from(document.querySelectorAll('.main-table tbody tr'))
                .map(tr => {
                    const link = tr.querySelector('td:nth-child(2) a');
                    return link ? parseInt(link.textContent) : null;
                })
                .filter(run => run !== null)
                .sort((a, b) => b - a)
                .join(',');
            csvRunNumbers.value = currentRuns;
        }
    } else {
        // Show all filtered run numbers
        csvRunNumbers.style.display = 'none';
        csvLoading.style.display = 'block';
        
        // Check cache first
        if (allRunNumbersCache) {
            csvRunNumbers.textContent = allRunNumbersCache;
            csvRunNumbers.style.display = 'block';
            csvLoading.style.display = 'none';
            return;
        }
        
        try {
            // Build URL with current filters but request all run numbers
            const url = new URL('/rdb/allRunNumbers', window.location.origin);
            const currentParams = new URLSearchParams(window.location.search);
            
            // Copy all filter parameters
            ['onlySignificant', 'minRun', 'maxRun', 'startTime', 'stopTime', 'runClass', 'comment',
             'dqMu3e', 'dqBeam', 'dqVtx', 'dqPix', 'dqFib', 'dqTil', 'dqLks'].forEach(param => {
                if (currentParams.has(param)) {
                    url.searchParams.set(param, currentParams.get(param));
                }
            });
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Failed to fetch all run numbers');
            }
            
            const runNumbers = await response.json();
            allRunNumbersCache = runNumbers.sort((a, b) => b - a).join(',');
            
            csvRunNumbers.value = allRunNumbersCache;
            csvRunNumbers.style.display = 'block';
            csvLoading.style.display = 'none';
        } catch (error) {
            console.error('Error fetching all run numbers:', error);
            csvLoading.textContent = 'Error loading run numbers: ' + error.message;
        }
    }
}
</script>
</head>

<% var runList = [] %>
<% for(const testData of data){ %>
<% runList.push(testData.BOR["Run number"]) %>
<% } %>


<body>
    <div id="runData" data-run='<%- JSON.stringify(data) %>' style="display: none;"></div>
    <div class="header-section">
        <h1><a href="/rdb/" style="text-decoration: none; color: inherit;">Mu3e Run Database</a></h1>
        
        <form id="filterForm" class="filter-section">
            <div class="filter-row">
                <div class="filter-group significant">
                    <label for="filterSignificant">Significant Runs only</label>
                    <input id="filterSignificant" type="checkbox" 
                        <% if (locals.onlySignificant === "yes") { %>checked<% } %>
                        onchange="significantFilter()" />
                </div>

                <div class="filter-group">
                    <label for="filterRunClass">Run class</label>
                    <select id="filterRunClass">
                        <option value="">All classes</option>
                        <option value="Beam" <% if (locals.runClass === 'Beam') { %>selected<% } %>>Beam</option>
                        <option value="Cosmic" <% if (locals.runClass === 'Cosmic') { %>selected<% } %>>Cosmic</option>
                        <option value="Source" <% if (locals.runClass === 'Source') { %>selected<% } %>>Source</option>
                        <option value="Calibration" <% if (locals.runClass === 'Calibration') { %>selected<% } %>>Calibration</option>
                        <option value="Test" <% if (locals.runClass === 'Test') { %>selected<% } %>>Test</option>
                        <option value="Junk" <% if (locals.runClass === 'Junk') { %>selected<% } %>>Junk</option>
                    </select>
                </div>

                <div class="filter-group run-range">
                    <label for="filterRunMin">Run range</label>
                    <input id="filterRunMin" type="numeric" placeholder="min" />
                    <input id="filterRunMax" type="numeric" placeholder="max" />
                </div>

                <div class="filter-group">
                    <label for="filterRunLimit">Max runs</label>
                    <input id="filterRunLimit" type="numeric" placeholder="limit" />
                </div>

                <div class="filter-group" style="flex-grow: 1;">
                    <label for="filterComment">Search comments</label>
                    <input id="filterComment" type="text" placeholder="search in comments" value="<%= locals.comment || '' %>" style="width: 100%;" />
                </div>

                <div class="filter-group">
                    <input type="button" class="button" value="Apply Filters" onclick="applyFilters()" />
                </div>
            </div>
            
            <!-- Data Quality Summary Filters (Collapsible) -->
            <div class="dq-filter-box">
                <div class="dq-filter-header" onclick="toggleDqFilters()">
                    <span>Data Quality Filters</span>
                    <span class="dq-toggle-icon">▼</span>
                </div>
                <div class="dq-filter-content" id="dqFilterContent">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="filterDqMu3e">Mu3e</label>
                            <select id="filterDqMu3e">
                                <option value="">Any</option>
                                <option value="1" <% if (locals.dqMu3e === '1') { %>selected<% } %>>Good</option>
                                <option value="0" <% if (locals.dqMu3e === '0') { %>selected<% } %>>Bad</option>
                                <option value="notbad" <% if (locals.dqMu3e === 'notbad') { %>selected<% } %>>Not Bad</option>
                                <option value="-1" <% if (locals.dqMu3e === '-1') { %>selected<% } %>>Unset</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterDqBeam">Beam</label>
                            <select id="filterDqBeam">
                                <option value="">Any</option>
                                <option value="1" <% if (locals.dqBeam === '1') { %>selected<% } %>>Good</option>
                                <option value="0" <% if (locals.dqBeam === '0') { %>selected<% } %>>Bad</option>
                                <option value="notbad" <% if (locals.dqBeam === 'notbad') { %>selected<% } %>>Not Bad</option>
                                <option value="-1" <% if (locals.dqBeam === '-1') { %>selected<% } %>>Unset</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterDqVtx">Vertex</label>
                            <select id="filterDqVtx">
                                <option value="">Any</option>
                                <option value="1" <% if (locals.dqVtx === '1') { %>selected<% } %>>Good</option>
                                <option value="0" <% if (locals.dqVtx === '0') { %>selected<% } %>>Bad</option>
                                <option value="notbad" <% if (locals.dqVtx === 'notbad') { %>selected<% } %>>Not Bad</option>
                                <option value="-1" <% if (locals.dqVtx === '-1') { %>selected<% } %>>Unset</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterDqPix">Pixel</label>
                            <select id="filterDqPix">
                                <option value="">Any</option>
                                <option value="1" <% if (locals.dqPix === '1') { %>selected<% } %>>Good</option>
                                <option value="0" <% if (locals.dqPix === '0') { %>selected<% } %>>Bad</option>
                                <option value="notbad" <% if (locals.dqPix === 'notbad') { %>selected<% } %>>Not Bad</option>
                                <option value="-1" <% if (locals.dqPix === '-1') { %>selected<% } %>>Unset</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterDqFib">Fibres</label>
                            <select id="filterDqFib">
                                <option value="">Any</option>
                                <option value="1" <% if (locals.dqFib === '1') { %>selected<% } %>>Good</option>
                                <option value="0" <% if (locals.dqFib === '0') { %>selected<% } %>>Bad</option>
                                <option value="notbad" <% if (locals.dqFib === 'notbad') { %>selected<% } %>>Not Bad</option>
                                <option value="-1" <% if (locals.dqFib === '-1') { %>selected<% } %>>Unset</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterDqTil">Tiles</label>
                            <select id="filterDqTil">
                                <option value="">Any</option>
                                <option value="1" <% if (locals.dqTil === '1') { %>selected<% } %>>Good</option>
                                <option value="0" <% if (locals.dqTil === '0') { %>selected<% } %>>Bad</option>
                                <option value="notbad" <% if (locals.dqTil === 'notbad') { %>selected<% } %>>Not Bad</option>
                                <option value="-1" <% if (locals.dqTil === '-1') { %>selected<% } %>>Unset</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterDqLks">Links</label>
                            <select id="filterDqLks">
                                <option value="">Any</option>
                                <option value="1" <% if (locals.dqLks === '1') { %>selected<% } %>>Good</option>
                                <option value="0" <% if (locals.dqLks === '0') { %>selected<% } %>>Bad</option>
                                <option value="notbad" <% if (locals.dqLks === 'notbad') { %>selected<% } %>>Not Bad</option>
                                <option value="-1" <% if (locals.dqLks === '-1') { %>selected<% } %>>Unset</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div class="status-text">
            <% if (locals.pagination) { %>
                Showing <%= (locals.pagination.currentPage - 1) * locals.pagination.pageSize + 1 %> - 
                <%= Math.min(locals.pagination.currentPage * locals.pagination.pageSize, locals.pagination.totalCount) %> 
                of <%= locals.pagination.totalCount %> runs
                (Page <%= locals.pagination.currentPage %> of <%= locals.pagination.totalPages %>)
                <% if (locals.onlySignificant === "yes") { %>
                    (significant runs only)
                <% } %>
            <% } else if (isFiltered) { %>
                Showing filtered results
                <% if (locals.onlySignificant === "yes") { %>
                    (significant runs only)
                <% } %>
            <% } else { %>
                Showing the last <%=data.length %> runs
                <% if (locals.onlySignificant === "yes") { %>
                    (significant runs only)
                <% } %>
            <% } %>
        </div>
        
    </div>

    <div class="content-section">
        <div class="bulk-actions">
            <div class="action-group">
                <label>Set Significant:</label>
                <select id="bulkSignificant">
                    <option value="true">Significant</option>
                    <option value="false">Not Significant</option>
                </select>
                <button class="button" onclick="performBulkAction('significant')">Apply</button>
            </div>
            <div class="action-group">
                <label>Add Comments:</label>
                <input type="text" id="bulkComments" placeholder="Enter comments to add" style="width: 300px;">
                <button class="button" onclick="performBulkAction('comments')">Apply</button>
            </div>
            <div class="action-group">
                <label>Set Class:</label>
                <select id="bulkClass">
                    <option value="Beam">Beam</option>
                    <option value="Cosmic">Cosmic</option>
                    <option value="Test">Test</option>
                    <option value="Calibration">Calibration</option>
                    <option value="Source">Source</option>
                    <option value="Junk">Junk</option>
                </select>
                <button class="button" onclick="performBulkAction('class')">Apply</button>
            </div>
            <div class="status"></div>
        </div>

        <div class="table-container">
            <table class="main-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" onchange="toggleAllRuns(this)"></th>
                        <th>Run</th>
                        <th>Start time</th>
                        <th>End time</th>
                        <th>Sig.</th>
                        <th>Class</th>
                        <th>Events</th>
                        <th>Shift crew</th>
                        <th>Shift Comments/RunInfo Comments</th>
                        <th>Resources</th>
                    </tr>
                </thead>
                <tbody>
                    <% data.map((result) => { %>
                        <tr>
                            <td><input type="checkbox" class="run-select" data-run="<%= result.BOR["Run number"] %>" onchange="toggleRun(this)"></td>
                            <td><a href="/rdb/run/<%= result.BOR["Run number"] %>"><%= result.BOR["Run number"] %></a></td>
                            <td><%= result.BOR["Start time"] %></td>
                            <td><%= result.EOR["Stop time"] %></td>
                            <% if (result.Attributes && result.Attributes.length > 0) { %>
                                <% const lastRunInfo = result.Attributes.filter(attr => attr.RunInfo).pop(); %>
                                <% if (lastRunInfo) { %>
                                    <td>
                                        <% if (lastRunInfo.RunInfo.Significant === "true") { %>
                                            <span class="status-significant">✓</span>
                                        <% } else if (lastRunInfo.RunInfo.Significant === "false") { %>
                                            <span class="status-not-significant">✗</span>
                                        <% } else { %>
                                            <span class="status-unset">n/a</span>
                                        <% } %>
                                    </td>
                                    <td><%= result.BOR["Run Class"] || 'n/a' %></td>
                                    <td><%= result.EOR["Events"] %></td>
                                    <td><%= result.BOR["Shift crew"] %></td>
                                    <td>
                                        <%= result.EOR["Comments"] %>
                                        <% if (lastRunInfo.RunInfo.Comments && lastRunInfo.RunInfo.Comments !== "unset") { %>
                                            /<%= lastRunInfo.RunInfo.Comments %>
                                        <% } %>
                                    </td>
                                <% } else { %>
                                    <td><span class="status-unset">N/A</span></td>
                                    <td>n/a</td>
                                    <td><%= result.EOR["Events"] %></td>
                                    <td><%= result.BOR["Shift crew"] %></td>
                                    <td><%= result.EOR["Comments"] %></td>
                                <% } %>
                            <% } else { %>
                                <td>-</td>
                                <td>n/a</td>
                                <td><%= result.EOR["Events"] %></td>
                                <td><%= result.BOR["Shift crew"] %></td>
                                <td><%= result.EOR["Comments"] %></td>
                            <% } %>
                            <td>
                                <% if (result.Resources && result.Resources.length > 0) { %>
                                    <% 
                                        // Flexible PDF check: type contains 'pdf' (case-insensitive)
                                        const pdfResources = result.Resources.filter(r => r.type && r.type.toLowerCase().includes('pdf'));
                                        const nonPdfResources = result.Resources.filter(r => !(r.type && r.type.toLowerCase().includes('pdf')));
                                        // Group PDF resources by description and get latest version of each type
                                        const resourcesByType = pdfResources
                                            .reduce((acc, resource) => {
                                                const desc = resource.description || 'No description';
                                                if (!acc[desc] || new Date(resource.uploadDate) > new Date(acc[desc].uploadDate)) {
                                                    acc[desc] = resource;
                                                }
                                                return acc;
                                            }, {});
                                        // Convert to array and sort by description
                                        const latestResources = Object.values(resourcesByType)
                                            .sort((a, b) => (a.description || '').localeCompare(b.description || ''));
                                    %>
                                    <% latestResources.forEach((resource, index) => { %>
                                        <% const resourceIndex = result.Resources.indexOf(resource); %>
                                        <a href="/rdb/resource/<%= result.BOR["Run number"] %>/<%= resourceIndex %>" 
                                           target="_blank" 
                                           title="<%= resource.filename %>"><%= resource.description || 'No description' %></a><% if (index < latestResources.length - 1) { %>, <% } %>
                                    <% }); %>
                                    <% if (nonPdfResources.length > 0) { %> <span style="color: #666; font-style: italic;">(more)</span><% } %>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <% if (locals.pagination && (locals.pagination.hasNextPage || locals.pagination.hasPrevPage || locals.pagination.totalPages > 1)) { %>
        <div class="pagination-container" style="
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        ">
            <button 
                onclick="goToPage(<%= locals.pagination.currentPage - 1 %>)" 
                <%= !locals.pagination.hasPrevPage ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : '' %>
                style="
                    padding: 8px 16px;
                    border: 1px solid #dee2e6;
                    background-color: white;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                "
            >← Previous</button>
            
            <div style="display: flex; gap: 5px; align-items: center;">
                <% 
                    const currentPage = locals.pagination.currentPage;
                    const totalPages = locals.pagination.totalPages;
                    let startPage = Math.max(1, currentPage - 2);
                    let endPage = Math.min(totalPages, currentPage + 2);
                    
                    // Adjust if we're near the start or end
                    if (endPage - startPage < 4) {
                        if (startPage === 1) {
                            endPage = Math.min(5, totalPages);
                        } else if (endPage === totalPages) {
                            startPage = Math.max(1, totalPages - 4);
                        }
                    }
                %>
                
                <% if (startPage > 1) { %>
                    <button onclick="goToPage(1)" <%= 1 === currentPage ? 'style="padding: 8px 12px; border: 2px solid #0d6efd; background-color: #0d6efd; color: white; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; min-width: 40px; box-sizing: border-box;"' : 'style="padding: 8px 12px; border: 2px solid transparent; background-color: white; border-radius: 4px; cursor: pointer; font-size: 14px; min-width: 40px; box-sizing: border-box;"' %>><%= 1 %></button>
                    <% if (startPage > 2) { %>
                        <span style="padding: 0 5px;">...</span>
                    <% } %>
                <% } %>
                
                <% for (let p = startPage; p <= endPage; p++) { %>
                    <button 
                        onclick="goToPage(<%= p %>)" 
                        <%= p === currentPage ? 'style="padding: 8px 12px; border: 2px solid #0d6efd; background-color: #0d6efd; color: white; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; min-width: 40px; box-sizing: border-box;"' : 'style="padding: 8px 12px; border: 2px solid transparent; background-color: white; border-radius: 4px; cursor: pointer; font-size: 14px; min-width: 40px; box-sizing: border-box;"' %>
                    ><%= p %></button>
                <% } %>
                
                <% if (endPage < totalPages) { %>
                    <% if (endPage < totalPages - 1) { %>
                        <span style="padding: 0 5px;">...</span>
                    <% } %>
                    <button onclick="goToPage(<%= totalPages %>)" <%= totalPages === currentPage ? 'style="padding: 8px 12px; border: 2px solid #0d6efd; background-color: #0d6efd; color: white; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; min-width: 40px; box-sizing: border-box;"' : 'style="padding: 8px 12px; border: 2px solid transparent; background-color: white; border-radius: 4px; cursor: pointer; font-size: 14px; min-width: 40px; box-sizing: border-box;"' %>><%= totalPages %></button>
                <% } %>
            </div>
            
            <button 
                onclick="goToPage(<%= locals.pagination.currentPage + 1 %>)" 
                <%= !locals.pagination.hasNextPage ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : '' %>
                style="
                    padding: 8px 16px;
                    border: 1px solid #dee2e6;
                    background-color: white;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                "
            >Next →</button>
            
            <div style="margin-left: 20px; display: flex; align-items: center; gap: 8px;">
                <label for="pageSizeSelect" style="font-size: 13px; color: #666;">Page size:</label>
                <select id="pageSizeSelect" onchange="changePageSize(this.value)" style="
                    padding: 6px 10px;
                    border: 1px solid #dee2e6;
                    border-radius: 4px;
                    font-size: 13px;
                ">
                    <option value="10" <%= locals.pageSize === 10 ? 'selected' : '' %>>10</option>
                    <option value="100" <%= locals.pageSize === 100 ? 'selected' : '' %>>100</option>
                    <option value="1000" <%= locals.pageSize === 1000 ? 'selected' : '' %>>1000</option>
                </select>
            </div>
        </div>
        <% } %>

        <div class="csv-box">
            <div class="csv-header">
                <span>Run Numbers (CSV)</span>
                <span class="toggle-icon">▼</span>
            </div>
            <!-- Status flag to track if CSV section is open -->
            <input type="hidden" id="csvSectionOpen" value="false">
            <div class="csv-content">
                <div style="margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 15px; flex-wrap: nowrap;">
                    <label style="cursor: pointer; white-space: nowrap;">
                        <input type="radio" name="csvScope" value="current" checked onchange="updateCsvDisplay()" style="margin-right: 5px;">
                        Current page only
                    </label>
                    <label style="cursor: pointer; white-space: nowrap;">
                        <input type="radio" name="csvScope" value="all" onchange="updateCsvDisplay()" style="margin-right: 5px;">
                        All filtered runs (<%= locals.pagination ? locals.pagination.totalCount : data.length %>)
                    </label>
                </div>
                <textarea id="csvRunNumbers" readonly style="
                    width: 100%;
                    min-height: 80px;
                    max-height: 250px;
                    font-family: monospace;
                    font-size: 11px;
                    padding: 5px;
                    border: 1px solid #ddd;
                    border-radius: 3px;
                    resize: vertical;
                    overflow-y: auto;
                    background-color: #f8f9fa;
                    margin: 0;
                "><% 
                    const runNumbers = data
                        .map(result => result.BOR["Run number"])
                        .sort((a, b) => b - a)
                        .join(',');
                %><%= runNumbers %></textarea>
                <script>
                    // Store current page run numbers for quick switching
                    currentPageRunNumbers = '<%= runNumbers %>';
                </script>
                <div id="csvLoading" style="display: none; text-align: center; padding: 10px; color: #666; font-size: 12px;">
                    Loading all run numbers...
                </div>
            </div>
        </div>

        <div style="
            margin-top: 20px;
            padding: 15px;
            text-align: center;
            color: #666;
            font-size: 13px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        ">
            Built with <a href="https://cursor.sh" target="_blank" style="
                color: #04AA6D;
                text-decoration: none;
                font-weight: 500;
            ">Cursor</a>
        </div>
    </div>
</body>

</html>
