# Nginx configuration for mu3edb0.psi.ch
# Place this file in /etc/nginx/sites-available/mu3edb0.conf
# Then create a symlink: sudo ln -s /etc/nginx/sites-available/mu3edb0.conf /etc/nginx/sites-enabled/
# Test with: sudo nginx -t
# And restart with: sudo systemctl restart nginx

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name mu3edb0.psi.ch mu3edb0;

    # Redirect HTTP to HTTPS (if SSL is configured)
    # Uncomment the following lines if you have SSL certificates:
    # return 301 https://$server_name$request_uri;

    # Reverse proxy for CDB
    location /cdb {
        proxy_pass http://mu3edb0:5050;
        include /etc/nginx/snippets/mu3edb0-proxy-common.conf;
    }

    # Reverse proxy for RDB
    location /rdb {
        proxy_pass http://mu3edb0:5050;
        include /etc/nginx/snippets/mu3edb0-proxy-common.conf;
    }
}

# HTTPS configuration - proxies to PartsDB on port 3001
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name mu3edb0.psi.ch mu3edb0;

    # SSL certificate paths (update these if you have proper certificates)
    # For self-signed certificate, use the paths below
    ssl_certificate /etc/nginx/ssl/mu3edb0.crt;
    ssl_certificate_key /etc/nginx/ssl/mu3edb0.key;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Reverse proxy for CDB (HTTPS)
    location /cdb {
        proxy_pass http://mu3edb0:5050;
        include /etc/nginx/snippets/mu3edb0-proxy-common.conf;
    }

    # Reverse proxy for RDB (HTTPS)
    location /rdb {
        proxy_pass http://mu3edb0:5050;
        include /etc/nginx/snippets/mu3edb0-proxy-common.conf;
    }

    # Reverse proxy for PartsDB at root
    location / {
        proxy_pass https://mu3edb0:3001;
        include /etc/nginx/snippets/mu3edb0-proxy-common.conf;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        # SSL settings for HTTPS backend connection
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
    }
}
